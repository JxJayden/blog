<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>vue.js 源码学习记录 | 江晓东的少年游</title>
  <meta name="description" content="江晓东的个人博客，记录关于计算机、前端、咖啡以及其他的东西" />
  <meta name="keywords" content="hexo,blog,JxJayden,f2e, front-end 前端 江晓东 博客 blog 咖啡 学习 记录 JavaScript CSS HTML code" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这是个人跟随 vue.js 源码 git history 学习的一些记录。持续更新。">
<meta property="og:type" content="article">
<meta property="og:title" content="vue.js 源码学习记录">
<meta property="og:url" content="http://blog.jxdjayden.cn/2017/03/30/vue/vue-learn-node/index.html">
<meta property="og:site_name" content="江晓东的少年游">
<meta property="og:description" content="这是个人跟随 vue.js 源码 git history 学习的一些记录。持续更新。">
<meta property="og:updated_time" content="2017-03-29T17:40:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vue.js 源码学习记录">
<meta name="twitter:description" content="这是个人跟随 vue.js 源码 git history 学习的一些记录。持续更新。">
  
  
    <link rel="icon" href="//odgdn5u95.bkt.clouddn.com/facvion.jpeg">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  

</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  我与我周旋久，宁作我
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          Home
        </a>
      
        <a href="/about" class="nav-about nav">
          About
        </a>
      
        <a href="/archives" class="nav-archives nav">
          Archives
        </a>
      
        <a href="https://github.com/JxJayden" class="nav-Github nav">
          Github
        </a>
      
        <a href="/links" class="nav-Links nav">
          Links
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      <article id="post-vue/vue-learn-node"
  class="post article white-box article-type-post"
  itemscope itemprop="blogPost">
	<h2 class="title">
  	<a href="/2017/03/30/vue/vue-learn-node/">
    	vue.js 源码学习记录
    </a>
  </h2>
	<time>
	  3月 30, 2017
	</time>
	<section class="content">
  	<div class="article-entry" itemprop="articleBody">
    	<p>这是个人跟随 vue.js 源码 git history 学习的一些记录。持续更新。</p>
<a id="more"></a>
<h2 id="5200951"><a href="#5200951" class="headerlink" title="[5200951]"></a>[5200951]</h2><h3 id="Seed-el-options"><a href="#Seed-el-options" class="headerlink" title="Seed(el, options)"></a>Seed(el, options)</h3><ul>
<li>拷贝 options 到 this</li>
<li>new Scope</li>
<li>如果有 data 则拷贝到 scope</li>
<li>invoke ctrl</li>
<li>call _compileNode</li>
<li>extract dependencies for computed properties</li>
</ul>
<h3 id="compileNode"><a href="#compileNode" class="headerlink" title="_compileNode"></a>_compileNode</h3><ul>
<li>文本节点：_compileTextNode</li>
<li><p>其他节点：</p>
<blockquote>
<p>if sd-each<br>parse as dir<br>seed bind dir</p>
<p>if ctrl but not root<br>new chid Seed</p>
<p>else<br>each attr</p>
<pre><code>each exp
    parse as dir
    seed bind dir
</code></pre><p>递归 compile child nodes</p>
</blockquote>
</li>
</ul>
<h3 id="compileTextNode"><a href="#compileTextNode" class="headerlink" title="_compileTextNode"></a>_compileTextNode</h3><h3 id="bind"><a href="#bind" class="headerlink" title="_bind"></a>_bind</h3><ul>
<li>traceOwnerSeed</li>
<li>call seed._createBinding</li>
<li>binding &lt;-&gt; dir</li>
<li>directive.bind // 指令执行前需要预处理，如：初始化变量</li>
<li>directive.update</li>
<li>directive.refresh</li>
</ul>
<h3 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h3><ul>
<li>property</li>
<li>$seed</li>
<li>$el</li>
<li>$index</li>
<li>$parent</li>
<li>$watchers</li>
<li>method</li>
<li>$watch</li>
<li>$unwatch</li>
<li>$dump</li>
<li>$destroy</li>
<li>$serialize</li>
</ul>
<h3 id="Directive-directive-parser"><a href="#Directive-directive-parser" class="headerlink" title="Directive (directive-parser)"></a>Directive (directive-parser)</h3><ul>
<li>new Directive(dirname, expression, oneway)</li>
<li>set this._update</li>
<li>call this.parseKey</li>
<li>call parseFilter</li>
<li>property</li>
<li>oneway</li>
<li>directiveName</li>
<li>expression</li>
<li>rawKey</li>
<li>filters</li>
<li>arg</li>
<li>inverse</li>
<li>nesting</li>
<li>root</li>
<li>key</li>
<li>method</li>
<li>update</li>
<li>refresh</li>
<li>apply</li>
<li>applyFilters</li>
<li>parseKey</li>
<li>parseFilter</li>
<li>deps-parser</li>
<li>observer</li>
<li>parse</li>
</ul>
<h3 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.inspect(utils.getNestedValue(seed.scope, path))</div><div class="line"><span class="keyword">this</span>.def(seed.scope, path) <span class="comment">// Define getter/setter for this binding on scope</span></div></pre></td></tr></table></figure>
<ul>
<li>property</li>
<li>seed</li>
<li>key</li>
<li>instances</li>
<li>subs</li>
<li>deps</li>
<li>isComputed</li>
<li>value</li>
<li>inspect (value)</li>
</ul>
<blockquote>
<p>Pre-process a passed in value based on its type<br>如果是 {get:, set:} 则标记 computed<br>如果是 Array, 则 拦截数组原生方法</p>
</blockquote>
<ul>
<li>def : 定义 getter/setter</li>
<li>update</li>
<li>pub: <code>each subs : dir.refresh()</code></li>
</ul>
<h2 id="498778e"><a href="#498778e" class="headerlink" title="[498778e]"></a>[498778e]</h2><blockquote>
<p>0.3.2 - make it actually work for Browserify</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">vm</div><div class="line">- $el</div><div class="line">- $parent</div><div class="line">- $compiler &lt;&lt;=&gt;&gt;</div><div class="line">	- el</div><div class="line">	- vm &lt;&lt;=&gt;&gt;</div><div class="line">	- directives [dir,...]</div><div class="line">					- rawKey // 除去过滤器</div><div class="line">					- expression // 完整</div><div class="line">					- directiveName</div><div class="line">					- _update</div><div class="line">					- filters [&#123;name:x,apply:x,args&#125;...]</div><div class="line">					- isExp</div><div class="line">					- nesting ^ 往上多少级父亲</div><div class="line">					- arg // arg: key</div><div class="line">					- key</div><div class="line">					- root (Bool)</div><div class="line">					- compiler: $compiler</div><div class="line">					- vm: &lt;&lt;=&gt;&gt; $compiler.vm</div><div class="line"></div><div class="line">	- expressions [binding] // 表达式</div><div class="line">	- observables [binding] // 非 &#123;get: xx&#125; 的对象 和 数组</div><div class="line">	- computed [binding] //  表达式 or &#123;get: xx&#125; 成员</div><div class="line">	- contextBindings[binding] // &#123;get: fun&#125; fun中有依赖的</div><div class="line">	- parentCompiler</div><div class="line">	- bindings [binding]</div><div class="line">					- value</div><div class="line">					- isComputed</div><div class="line">					- rawGet</div><div class="line">					- contextDeps</div><div class="line"></div><div class="line">	- rootCompiler</div><div class="line">	- observer(Emitter)</div><div class="line">		- proxies &#123;&#125;</div><div class="line"></div><div class="line">-------------------------------------------------------------------------------</div><div class="line"></div><div class="line">compiler.bindings = &#123;</div><div class="line">	value</div><div class="line">	isExp (Bool)</div><div class="line">	root</div><div class="line">	compiler &lt;&lt;=&gt;&gt; $compiler</div><div class="line">	key: &#123;&#125;</div><div class="line">	instances: []</div><div class="line">	subs: []</div><div class="line">	deps: []</div><div class="line">&#125;</div><div class="line"></div><div class="line">-------------------------------------------------------------------------------</div><div class="line"></div><div class="line">依赖关系是用 binding 的引用</div><div class="line"></div><div class="line">binding.update()</div><div class="line">    each dir in instances : dir.update()</div><div class="line">    call pub()</div><div class="line">        ==&gt;</div><div class="line">        each binding in subs : dir.refresh()</div><div class="line">                                    ==&gt;</div><div class="line">                                    each dir in instances : dir.refresh()</div><div class="line"></div><div class="line">外部引起的值改变先是 update 再触发依赖自己的 computed 成员去 refresh</div></pre></td></tr></table></figure>
<hr>
<h3 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h3><ul>
<li>ViewModel(options) =&gt; new Compiler(ViewModel, options)</li>
<li>$set 对 vm 设值，key 可以为 a.b.c 这样的</li>
<li>$get</li>
<li>$watch</li>
<li>$unwatch</li>
<li>$destroy</li>
</ul>
<h3 id="Compiler"><a href="#Compiler" class="headerlink" title="Compiler"></a>Compiler</h3><ul>
<li>Compiler</li>
</ul>
<ol>
<li>extend(options)</li>
<li>extend(options.data)</li>
<li>determine el</li>
<li>prototypal inheritance of bindings</li>
<li>setup observer</li>
<li>call options.init</li>
<li>for key in vm : createBinding(key)</li>
<li>compileNode</li>
<li>for bindIns in observables : Observer.observe(bindIns.value, bindIns.key, this.observer)</li>
<li>DepsParser.parse(computed)</li>
<li>bindContexts(ctxBindings)</li>
</ol>
<ul>
<li>setupObserver</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">observer</div><div class="line">	.on(&apos;get&apos;, callback)</div><div class="line">	.on(&apos;set&apos;, callback)</div><div class="line">	.on(&apos;mutate&apos;, callback)</div></pre></td></tr></table></figure>
<ul>
<li>compileNode</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">if textNode</div><div class="line">	compileTextNode</div><div class="line">else if 标签元素</div><div class="line">	if sd-each</div><div class="line">		parse then bindDirective</div><div class="line">else if sd-vm 且 非根</div><div class="line">	new ChildVM</div><div class="line">else // normal node</div><div class="line">	遍历属性，跳过有 vm 声明的</div><div class="line">	遍历表达式</div><div class="line">	parse then bindDirective</div><div class="line">	递归 compile 子元素</div></pre></td></tr></table></figure>
<ul>
<li>createBinding(key, isExp)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">new Binding</div><div class="line">表达式</div><div class="line">	ExpParser.parseGetter</div><div class="line">	binding.value = &#123; get: getter &#125;</div><div class="line">	this.markComputed(binding)</div><div class="line">	this.expressions.push(binding)</div><div class="line">非表达式</div><div class="line">	compiler.bindings[key] = new Binding</div><div class="line">	ensurePath(key)</div><div class="line">	对如 `a.b.c` 这类，会保证</div><div class="line">    binding = &#123;</div><div class="line">        &apos;a&apos;:</div><div class="line">        &apos;a.b&apos;:</div><div class="line">        &apos;a.b.c&apos;:</div><div class="line">    &#125;</div><div class="line">    每层 path 都有一个 bindingIns # question</div><div class="line">    只对第一层 path 调用 this.define(a, aKeyBinding)</div></pre></td></tr></table></figure>
<ul>
<li>bindDirective</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">find target compiler: traceOwnerCompiler</div><div class="line">var binding</div><div class="line">设置 subs</div><div class="line">执行开发者的 bind hook</div><div class="line">if computed</div><div class="line">	call refresh</div><div class="line">else</div><div class="line">	call update</div></pre></td></tr></table></figure>
<ul>
<li>markComputed</li>
<li>define: Defines the getter/setter for a root-level binding on the VM</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">针对根成员，定义 getter/setter，另外 observables 也是在这里收集的</div><div class="line"></div><div class="line">难点：</div><div class="line">getter 会触发 &apos;get&apos; 事件，目前是为了依赖侦测，为了获得最『纯净』的底层依赖，</div><div class="line">对以下类型不触发，因为以下类型的值肯定依赖更深的属性：isComputed value.__observer__ array</div><div class="line"></div><div class="line">setter</div><div class="line">对于 computed 的，有 set 方法就直接用，没有就不管。</div><div class="line">非 computed, 先移除旧的 observe，然后再设置新的的 observe</div></pre></td></tr></table></figure>
<ul>
<li>bindContexts</li>
<li>destroy</li>
</ul>
<h3 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h3><ul>
<li>Directive (directiveName, expression)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">each definition</div><div class="line">	this._update =</div><div class="line">	this.xxx = xxx</div><div class="line">parse key</div><div class="line">parse filters</div></pre></td></tr></table></figure>
<ul>
<li>update 值改变的时候会调用，只针对非 computed</li>
<li>refresh 值改变的时候会调用，只针对 computed 成员，当所依赖发生改变时</li>
<li>apply: Actually invoking the _update from the directive’s definition</li>
</ul>
<h3 id="ExpParser-from-https-github-com-RubyLouvre-avalon"><a href="#ExpParser-from-https-github-com-RubyLouvre-avalon" class="headerlink" title="ExpParser from https://github.com/RubyLouvre/avalon"></a>ExpParser from <a href="https://github.com/RubyLouvre/avalon" target="_blank" rel="external">https://github.com/RubyLouvre/avalon</a></h3><h2 id="f4861ca"><a href="#f4861ca" class="headerlink" title="[f4861ca]"></a>[f4861ca]</h2><h3 id="func-main-js"><a href="#func-main-js" class="headerlink" title="func (main.js)"></a>func (main.js)</h3><ul>
<li><p>config(opts) 个人设置</p>
</li>
<li><p>directive(id, fn) 注册指令</p>
</li>
<li><p>filter(id, fn) 注册 filter 指令</p>
</li>
<li><p>component(id, Ctor)</p>
<blockquote>
<p>注册组件，用 util.toConstructor 转为 ViewModel(或子类)</p>
</blockquote>
</li>
<li><p>partial(id, partial)</p>
<blockquote>
<p>注册模板，用 utils.toFragment 转为 frag 节点</p>
</blockquote>
</li>
<li><p>transition(id, transition)</p>
<blockquote>
<p>注册动画 def</p>
</blockquote>
</li>
<li><p>extend(options)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Expose the main ViewModel class and add extend method</div></pre></td></tr></table></figure>
</li>
<li><p>inheritOptions (child, parent, topLevel)</p>
<blockquote>
<p>对象则 拷贝 (一层)，方法则 mergeHook，忽略 el methods</p>
</blockquote>
</li>
<li><p>mergeHook (fn, parentFn)</p>
</li>
<li><p>updatePrefix ()</p>
</li>
<li><p>setPrefix()</p>
</li>
</ul>
<h3 id="Compiler-1"><a href="#Compiler-1" class="headerlink" title="Compiler"></a>Compiler</h3><p><strong>props</strong></p>
<ul>
<li>init</li>
<li>options</li>
<li>data</li>
<li>el</li>
<li>vm</li>
<li>dirs</li>
<li>exps</li>
<li>computed</li>
<li>childCompilers</li>
<li>emitter (Emitter)</li>
<li>parentCompiler</li>
<li>bindings {}</li>
<li>rootCompiler</li>
<li>childId</li>
<li>observer<ul>
<li>proxies</li>
</ul>
</li>
<li>[repeatIndex]</li>
<li>$</li>
<li>$el</li>
<li>$compiler</li>
<li>$root</li>
</ul>
<p><strong>func</strong></p>
<ul>
<li>Compiler(vm, options)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">compiler.init = true // indicate intiating this instance</div><div class="line"></div><div class="line">// process and extend options</div><div class="line"></div><div class="line">// copy data, methods &amp; compiler options</div><div class="line"></div><div class="line">// initialize element</div><div class="line"></div><div class="line">// set compiler properties</div><div class="line"></div><div class="line">// inherit parent bindings</div><div class="line"></div><div class="line">// set inenumerable VM properties</div><div class="line"></div><div class="line">// set parent VM</div><div class="line">// and register child id on parent</div><div class="line"></div><div class="line">// setup observer</div><div class="line"></div><div class="line">// beforeCompile hook</div><div class="line"></div><div class="line">// the user might have set some props on the vm</div><div class="line">// so copy it back to the data...</div><div class="line"></div><div class="line">// observe the data</div><div class="line">Observer.observe(data, &apos;&apos;, compiler.observer)</div><div class="line"></div><div class="line">// for repeated items, create an index binding</div><div class="line">// which should be inenumerable but configurable</div><div class="line"></div><div class="line">// allow the $data object to be swapped</div><div class="line"></div><div class="line">// now parse the DOM</div><div class="line">	// create necessary bindings</div><div class="line">	// bind the parsed directives</div><div class="line"></div><div class="line">// extract dependencies for computed properties</div><div class="line"></div><div class="line">// done! post compile / ready hook</div></pre></td></tr></table></figure>
<ul>
<li><p>setupElement(options)</p>
<blockquote>
<p> Initialize the VM/Compiler’s element. Fill it in with the template if necessary.</p>
</blockquote>
</li>
<li><p>setupObserver</p>
<blockquote>
<p>Setup observer.The observer listens for get/set/mutate events on all VM</p>
</blockquote>
</li>
<li><p>compile(node, root)</p>
</li>
<li><p>compileNode(node)</p>
</li>
<li><p>compileTextNode(node)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// TextParser.parse as tokens</div><div class="line">// each tokens:</div><div class="line">    //if a binding with key</div><div class="line">        // if &apos;&gt;&apos; as partialId, compileNode()</div><div class="line">        // else parse as sd-text then bind dir</div><div class="line"></div><div class="line">    //if a plain string then createTextNode(token)</div></pre></td></tr></table></figure>
</li>
<li><p>bindDirective(direcitve)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// append to dirs</div><div class="line"></div><div class="line">// if a simple directive simply call its bind() or _update()</div><div class="line"></div><div class="line">// if exp</div><div class="line">    // expression bindings, created on current compiler</div><div class="line">// if data or vm has baseKey</div><div class="line">	// Create the binding if it&apos;s not created already.</div><div class="line">// else</div><div class="line">	// 由于绑定的原型继承，如果绑定对象上不存在键，那么它不存在于整个原型链中。</div><div class="line">	// 在这种情况下，我们在根级别创建新的绑定。</div><div class="line">// invoke bind hook if exists</div><div class="line"></div><div class="line">// set initial value</div><div class="line">	refresh for computed. update for other</div></pre></td></tr></table></figure>
</li>
<li><p>createBinding(key, isExp, isFn)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// Create binding and attach getter/setter for a key to the viewmodel object</div><div class="line"></div><div class="line">// if isExp</div><div class="line">// a complex expression binding</div><div class="line">// parse exp to generate an anonymous computed property &#123;$get:xx&#125;</div><div class="line">// apply `value`</div><div class="line">// mark computed</div><div class="line">// push to exps</div><div class="line"></div><div class="line">// just key</div><div class="line">// if root</div><div class="line">	// define getter/setters for it.</div><div class="line">// else</div><div class="line">	// ensure path in data so it can be observed</div><div class="line">	// this is a nested value binding, but the binding for its parent</div><div class="line">	// has not been created yet. We better create that one too.</div></pre></td></tr></table></figure>
</li>
<li><p>define(key, binding)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Defines the getter/setter for a root-level binding on the VM and observe the initial value</div><div class="line"></div><div class="line">binding.value = data[key] // save the value before redefinening it</div><div class="line">// set 事件两次 ? question</div><div class="line">// if (data.__observer__) &#123;</div><div class="line">//     Observer.convert(data, key)</div><div class="line">// &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>markComputed(binding) Process a computed property binding</p>
</li>
<li><p>getOption(type, id)</p>
</li>
<li><p>execHook</p>
</li>
<li><p>destroy</p>
</li>
<li><p>getRoot</p>
</li>
</ul>
<h3 id="ViewModel-1"><a href="#ViewModel-1" class="headerlink" title="ViewModel"></a>ViewModel</h3><p><strong>props</strong></p>
<ul>
<li>${chidid:,…}</li>
<li>$el</li>
<li>$compiler</li>
<li>$root</li>
<li>$parent</li>
</ul>
<p><strong>func</strong></p>
<ul>
<li>ViewModel(options) 直接 new Compiler</li>
<li>$set(key, value) 找到 basekey 对应 vm 然后设置</li>
<li>$watch(key, callback)</li>
<li>$unwatch</li>
<li>$destroy</li>
<li>$broadcast() 递归向下发布事件</li>
<li>$emit 自身 &amp; 往上递归发事件</li>
<li>$on ()</li>
<li>$off ()</li>
<li>$once ()</li>
<li>$appendTo (target, cb)</li>
<li>$remove (cb)</li>
<li>$before (target, cb)</li>
<li>$after (target, cb)</li>
<li>getTargetVM (vm, path)</li>
</ul>
<h3 id="Directive-1"><a href="#Directive-1" class="headerlink" title="Directive"></a>Directive</h3><p><strong>props</strong></p>
<ul>
<li>compiler</li>
<li>vm</li>
<li>el</li>
<li>isSimple</li>
<li>expression</li>
<li>bind 或 _update</li>
<li>rawKey</li>
<li>key</li>
<li>isExp</li>
<li>filters</li>
</ul>
<p><strong>func</strong></p>
<ul>
<li>update</li>
<li>refresh – computed property only –</li>
<li>apply</li>
<li>applyFilters</li>
<li>unbind</li>
<li>split</li>
<li>parse</li>
</ul>
<h3 id="Binding-1"><a href="#Binding-1" class="headerlink" title="Binding"></a>Binding</h3><blockquote>
<p>每一个 vm 上的属性（路径）都有一个对应的 Binding 对象，这个对象有多个作用在 DOM 上的 指令 实例，以及多个依赖 binding 跟属性一一对应，所以 update 等方法的触发入口是属性被改变了</p>
</blockquote>
<p><strong>props</strong></p>
<ul>
<li>value</li>
<li>isExp</li>
<li>isFn</li>
<li>root</li>
<li>compiler</li>
<li>key</li>
<li>subs = []</li>
<li>deps = []</li>
<li>isComputed // 表达式 / {$get:xx}</li>
<li>instances [,…]</li>
</ul>
<p><strong>func</strong></p>
<ul>
<li><p>update</p>
</li>
<li><p>refresh</p>
</li>
<li><p>pub</p>
<blockquote>
<p>Notify computed properties that depend on this binding to update themselves</p>
</blockquote>
</li>
<li><p>unbind</p>
<blockquote>
<p> Unbind the binding, remove itself from all of its dependencies</p>
</blockquote>
</li>
</ul>
<h3 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h3><ul>
<li>watchObject<ul>
<li>convert</li>
</ul>
</li>
<li>isWatchable (obj)</li>
<li>emitSet</li>
<li>copyPaths //保证旧对象的叶子路径都在新对象上</li>
<li>ensurePath  // 保证 各层路径 accessed 和 enumerated</li>
<li>observe (obj, rawPath, observer)</li>
<li>unobserve</li>
</ul>
<h1 id="b7e83e61-1-0-10"><a href="#b7e83e61-1-0-10" class="headerlink" title="[b7e83e61] 1.0.10"></a>[b7e83e61] 1.0.10</h1><h2 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h2><blockquote>
<p>添加 Vue.options 默认属性，如果使用了 vue 开发者工具，则激活。</p>
</blockquote>
<h2 id="instance"><a href="#instance" class="headerlink" title="instance"></a>instance</h2><h3 id="vue-js"><a href="#vue-js" class="headerlink" title="vue.js"></a>vue.js</h3><blockquote>
<p>在 Vue 上挂载属性和 API 并且Vue.init</p>
<p>this._init(options)</p>
</blockquote>
<h3 id="internal-init-js"><a href="#internal-init-js" class="headerlink" title="internal/init.js"></a>internal/init.js</h3><h4 id="1-Vue-prototype-init-options"><a href="#1-Vue-prototype-init-options" class="headerlink" title="1. Vue.prototype._init(options)"></a>1. Vue.prototype._init(options)</h4><blockquote>
<p>主要生成队列</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">Vue:</div><div class="line">prop:</div><div class="line">$el</div><div class="line">$parent &lt;=&gt; options.parent</div><div class="line">$root: options.parent ? options.parent.$root : <span class="keyword">this</span></div><div class="line">$children: []</div><div class="line">$refs:&#123;&#125;  <span class="comment">// child vm references</span></div><div class="line">$els: &#123;&#125; <span class="comment">// element references</span></div><div class="line">_watchers: [] <span class="comment">// 所有的数据订阅者</span></div><div class="line">_directives: [] <span class="comment">// 所有的指令</span></div><div class="line"></div><div class="line">_uid: uid</div><div class="line"></div><div class="line">isVue: <span class="literal">true</span> <span class="comment">// 一个避免本身被 observed 的标志 //Q</span></div><div class="line"></div><div class="line">_events: &#123;&#125; <span class="comment">// 注册的回调</span></div><div class="line">_eventsCount: &#123;&#125; <span class="comment">// for $broadcast 优化 //Q</span></div><div class="line"></div><div class="line">_isFragment = <span class="literal">false</span></div><div class="line">_fragment = _fragmentStart = _fragmentEnd = <span class="literal">null</span></div><div class="line"></div><div class="line"><span class="comment">// 生命周期状态</span></div><div class="line"><span class="keyword">this</span>._isCompiled =</div><div class="line"><span class="keyword">this</span>._isDestroyed =</div><div class="line"><span class="keyword">this</span>._isReady =</div><div class="line"><span class="keyword">this</span>._isAttached =</div><div class="line"><span class="keyword">this</span>._isBeingDestroyed = <span class="literal">false</span></div><div class="line"><span class="keyword">this</span>._unlinkFn = <span class="literal">null</span></div><div class="line"></div><div class="line">_context: options._context || <span class="keyword">this</span>.$parent <span class="comment">// 上下文</span></div><div class="line"></div><div class="line">_scope: options._scope 作用域</div><div class="line"></div><div class="line">_frag: options._frag</div><div class="line"><span class="comment">// 如果这个实例被编译在一个 Fragment 内部，它需要将自己注册为该 fragment 的一个子对象，以便 attach / detach 能正常工作。</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>._frag) &#123;</div><div class="line">  <span class="keyword">this</span>._frag.children.push(<span class="keyword">this</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// push self into parent / transclusion host</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.$parent) &#123;</div><div class="line">  <span class="keyword">this</span>.$parent.$children.push(<span class="keyword">this</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">$options: mergeOptions() <span class="comment">// merge options. 混合选项</span></div><div class="line"></div><div class="line">_updateRef() <span class="comment">// set ref //Q // Update v-ref for component.</span></div><div class="line"></div><div class="line">_data = &#123;&#125;</div><div class="line"></div><div class="line">_callHook(<span class="string">'init'</span>) <span class="comment">// call init hook</span></div><div class="line"></div><div class="line">_initState() <span class="comment">// 初始化数据观察和作用域继承</span></div><div class="line"></div><div class="line">_initEvents() <span class="comment">// 初始化事件</span></div><div class="line"></div><div class="line">_callHook(<span class="string">'created'</span>) <span class="comment">// call created hook</span></div><div class="line"></div><div class="line"><span class="comment">// 如果有 options.el 则开始 $mount</span></div><div class="line"><span class="keyword">if</span> (options.el) &#123;</div><div class="line">  <span class="keyword">this</span>.$mount(options.el)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="state-js"><a href="#state-js" class="headerlink" title="state.js"></a>state.js</h3><blockquote>
<p>Accessor for <code>$data</code> property, since setting $data requires observing the new object and updating proxied properties.</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">defined Vue $data =&gt; <span class="keyword">if</span> newData =&gt; _setData(newData)</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Setup the scope of an instance, which contains:</div><div class="line"> * - observed data</div><div class="line"> * - computed properties</div><div class="line"> * - user methods</div><div class="line"> * - meta properties</div><div class="line"> */</div><div class="line">set Vue.prototype._initState =&gt; &#123;</div><div class="line">  <span class="keyword">this</span>._initProps()</div><div class="line">  <span class="keyword">this</span>._initMeta()</div><div class="line">  <span class="keyword">this</span>._initMethods()</div><div class="line">  <span class="keyword">this</span>._initData()</div><div class="line">  <span class="keyword">this</span>._initComputed()</div><div class="line">&#125;</div><div class="line"></div><div class="line">_initProps =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> options.props</div><div class="line">    compileAndLinkProps(<span class="keyword">this</span>, el, props, <span class="keyword">this</span>._scope)</div><div class="line">    compileAndLinkProps <span class="comment">// 在 compiler/compile.js 中</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">_initMeta <span class="comment">// Initialize meta information like $index, $key &amp; $value.</span></div><div class="line"></div><div class="line">_initMethods <span class="comment">// setup instance methods 绑定方法示例，并且把 this 指向 Vue</span></div><div class="line"></div><div class="line">_initData =&gt; &#123; <span class="comment">// Initialize the data.</span></div><div class="line">  <span class="comment">// 先检测 data 有没有被定义为 prop</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._props[prop].raw !== <span class="literal">null</span> ||!hasOwn(optionsData, prop</div><div class="line">  	set <span class="comment">// Set a property on an object. Adds the new property and triggers change notification if the property doesn't already exist.</span></div><div class="line"></div><div class="line">  <span class="keyword">this</span>._proxy(data.allkey) <span class="comment">//proxy data on instance</span></div><div class="line">  observe(data, <span class="keyword">this</span>) <span class="comment">// observe data</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">_initComputed =&gt; &#123; <span class="comment">// Setup computed properties.</span></div><div class="line">  <span class="keyword">if</span> computed(key) 为 funciton</div><div class="line">  	makeComputedGetter</div><div class="line">  <span class="keyword">else</span></div><div class="line">    分别处理 get set</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, key, def)</div><div class="line">&#125;</div><div class="line"></div><div class="line">Vue.prototype._setData =&gt; &#123; <span class="comment">// Swap the instance's $data. Called in $data's setter.</span></div><div class="line">  <span class="keyword">if</span> key not <span class="keyword">in</span> <span class="keyword">new</span> data =&gt; <span class="keyword">this</span>._unproxy(key)</div><div class="line"></div><div class="line">  <span class="keyword">if</span> key not <span class="keyword">in</span> old data but <span class="keyword">in</span> <span class="keyword">new</span> data =&gt; <span class="keyword">this</span>._proxy(key)</div><div class="line">  oldData.__ob__.removeVm(<span class="keyword">this</span>)</div><div class="line">  observe(newData, <span class="keyword">this</span>)</div><div class="line">  <span class="keyword">this</span>._digest() <span class="comment">// Force update on every watcher in scope.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">Vue.prototype._proxy =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> !isReserved(key)</div><div class="line">    <span class="built_in">Object</span>.defineProperty(self, key, &#123;</div><div class="line">        configurable: <span class="literal">true</span>,</div><div class="line">        enumerable: <span class="literal">true</span>,</div><div class="line">        get: <span class="function"><span class="keyword">function</span> <span class="title">proxyGetter</span> (<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> self._data[key]</div><div class="line">        &#125;,</div><div class="line">        set: <span class="function"><span class="keyword">function</span> <span class="title">proxySetter</span> (<span class="params">val</span>) </span>&#123;</div><div class="line">          self._data[key] = val</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

  	</div>

	  <div class="article-tags tags">
		  
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a><a class="tag-link" href="/tags/learn/">learn</a><a class="tag-link" href="/tags/note/">note</a><a class="tag-link" href="/tags/vue/">vue</a>
      
	  </div>
	</section>
</article>


<section id="comments">
	<div id="disqus_thread"></div>
</section>



      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  

	<div class="social-wrapper">
  	
      
        <a href="mailto:jxdjayden@gmail.com" class="social email"
          target="_blank" rel="external">
          <span class="icon icon-email"></span>
        </a>
      
        <a href="https://github.com/JxJayden" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">江晓东的少年游</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'blog-jxdjayden-cn';
  
  var disqus_url = 'http://blog.jxdjayden.cn/2017/03/30/vue/vue-learn-node/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>

<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "";
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
